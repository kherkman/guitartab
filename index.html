<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics-Based Fretboard & Chord/Scale Library</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #333; color: #f0f0f0; display: flex; justify-content: center; align-items: center; flex-direction: column; margin: 0; padding: 20px; user-select: none; }
        #app { background-color: #444; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 98%; max-width: 1400px; }
        h1 { text-align: center; margin-top: 0; color: #e0a800; }
        .controls { display: flex; justify-content: center; gap: 10px 15px; flex-wrap: wrap; margin-bottom: 25px; padding: 15px; background-color: #2c2c2c; border-radius: 8px; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        .control-group label { font-weight: bold; }
        button, select { padding: 8px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; background-color: #e0a800; color: #333; font-weight: bold; transition: background-color 0.2s; }
        button:hover, select:hover { background-color: #ffc107; }
        button:disabled { background-color: #666; cursor: not-allowed; }
        #recognized-chord-display { font-weight: bold; color: #ffc107; margin-left: 10px; }
        #main-layout { display: grid; transition: grid-template-columns 0.3s ease-in-out; }
        #string-controls-container, #fretboard-container { display: flex; flex-direction: column-reverse; gap: 6px; }
        .string-control-panel { background: #3a3a3a; border-radius: 5px; padding: 5px 10px; height: 25px; display: flex; align-items: center; gap: 8px; font-size: 0.8em; }
        .input-group { display: flex; align-items: center; gap: 4px; }
        .input-group input { background: #555; color: #fff; border: 1px solid #777; border-radius: 3px; padding: 2px; box-sizing: border-box; text-align: center; }
        input[id^="len-"], input[id^="ten-"] { width: 50px; }
        input[id^="wid-"] { width: 60px; }
        .info-display { margin-left: auto; display: flex; align-items: center; gap: 15px; font-weight: bold; color: #ffc107; white-space: nowrap; }
        .remove-string-btn { background-color: #dc3545; color: white; padding: 0; width: 20px; height: 20px; line-height: 20px; border-radius: 50%; font-size: 14px; margin-left: 10px; }
        .remove-string-btn:hover { background-color: #c82333; }
        #fretboard-outer-container { background-color: #8B4513; border: 2px solid #222; border-radius: 5px; padding: 20px 10px; box-shadow: inset 0 0 20px rgba(0,0,0,0.4); }
        .string-row { position: relative; display: flex; width: 100%; height: 25px; }
        .string-row::before { content: ''; position: absolute; width: 100%; height: 2px; background-color: #ccc; top: 50%; left: 0; transform: translateY(-50%); z-index: 1; }
        .fret-space { height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; }
        .fret-divider { position: absolute; top: -5px; bottom: -5px; width: 4px; background-color: #aaa; cursor: col-resize; z-index: 5; transform: translateX(-50%); border-left: 1px solid #777; border-right: 1px solid #777; }
        .open-string-space { width: 50px; flex-shrink: 0; background-color: rgba(0,0,0,0.1); }
        .fretted-area { flex: 1; display: flex; position: relative; border-left: 8px solid #f0f0f0; }
        .note { position: absolute; top: 50%; width: 28px; height: 22px; line-height: 22px; background: radial-gradient(circle at 30% 30%, #4a90e2, #245a9e); border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.5); cursor: grab; z-index: 10; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); padding: 0 2px; }
        .note.dragging { opacity: 0.5; cursor: grabbing; }
        .mute-marker { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: #ffc107; font-size: 1.5em; font-weight: bold; text-shadow: 1px 1px 2px black; }
        .comments { margin-top: 20px; background: #2c2c2c; padding: 10px 15px; border-radius: 5px; font-size: 0.9em; text-align: left; }
        .comments h3 { margin-top: 0; color: #e0a800; }
        .comments ul { padding-left: 20px; margin: 0; }
        .comments p { margin: 5px 0; }
        .comments code { background: #555; padding: 2px 5px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Physics-Based Fretboard & Chord/Scale Library</h1>
        <div class="controls">
            <div class="control-group"><label>Chord:</label><select id="root-note-select"></select><select id="chord-type-select"></select><button id="show-chord-btn">Show</button><button id="clear-fretboard-btn">Clear</button><span id="recognized-chord-display"></span></div>
            <div class="control-group"><label>Scale:</label><select id="scale-type-select"></select><button id="show-scale-btn">Show</button><button id="random-scale-btn">Random</button><select id="notes-per-string-select"><option value="all">All Notes</option><option value="3">3 per String</option><option value="4">4 per String</option></select></div>
            <div class="control-group"><label>Strings:</label><button id="add-string-below">Add Below</button><button id="add-string-above">Add Above</button></div>
            <div class="control-group"><label>Frets:</label><button id="remove-fret">-</button><span id="fret-count">12</span><button id="add-fret">+</button></div>
            <div class="control-group"><label>Note Display:</label><select id="display-mode"><option value="names">Note Names</option><option value="frequencies">Frequencies</option><option value="intervals">Intervals</option><option value="fingerings">Fingerings</option></select></div>
            <div class="control-group"><label for="setup-select">Setup:</label><select id="setup-select"><option value="" disabled selected>Select Preset...</option><option value="guitar">Standard Guitar</option><option value="bass">Standard Bass</option><option value="ukulele">Standard Ukulele</option><option value="drop_d">Drop D</option><option value="open_g">Open G</option><option value="dadgad">DADGAD</option><option value="7_string">7-String Guitar</option><option value="8_string">8-String Guitar</option><option value="just_intonation">Just Intonation</option><option value="overtone">Overtone Series Demo</option></select></div>
            <div class="control-group"><button id="reset-frets">Reset All</button><button id="toggle-tuning-panel">Hide Tuning</button></div>
        </div>
        <div id="main-layout"><div id="string-controls-container"></div><div id="fretboard-outer-container"><div id="fretboard-container"></div></div></div>
        <div class="comments"><h3>How To Use</h3><ul><li><strong>Setups & Demos:</strong> Use the "Setup" dropdown to configure the instrument for various tunings or temperaments.</li><li><strong>Chords & Scales:</strong> Select a root note and a type, then click "Show".</li><li><strong>Chord Recognizer:</strong> Manually place 3 or more notes to see the recognized chord name appear automatically.</li><li><strong>Manual Mode:</strong> Left-click any fret space to add/remove your own notes (this clears any displayed chord/scale).</li></ul></div>
        <div class="comments"><h3>Physics Formula</h3><p><code>frequency = (1 / (2 * L)) * sqrt(T / μ)</code> where L=Length, T=Tension, μ=Linear Density.</p></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS ---
            const MIN_STRINGS = 1, MAX_STRINGS = 12, MIN_FRETS = 0, MAX_FRETS = 24;
            const STEEL_DENSITY_KG_M3 = 7850, LBS_TO_NEWTONS = 4.44822, INCH_TO_METER = 0.0254;
            const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const GUITAR_TUNING_HZ = [82.41,110.00,146.83,196.00,246.94,329.63], GUITAR_GAUGES = [0.042,0.032,0.024,0.016,0.011,0.009];
            const BASS_TUNING_HZ = [41.20,55.00,73.42,98.00], BASS_GAUGES = [0.105,0.085,0.065,0.045];
            const UKULELE_TUNING_HZ = [392.00,261.63,329.63,440.00], UKULELE_GAUGES = [0.028,0.040,0.032,0.022];
            const DROP_D_TUNING_HZ = [73.42,110.00,146.83,196.00,246.94,329.63], DROP_D_GAUGES = GUITAR_GAUGES;
            const OPEN_G_TUNING_HZ = [73.42,98.00,146.83,196.00,246.94,293.66], OPEN_G_GAUGES = [0.046,0.036,0.026,0.017,0.013,0.010];
            const DADGAD_TUNING_HZ = [73.42,110.00,146.83,196.00,220.00,293.66], DADGAD_GAUGES = [0.056,0.042,0.032,0.024,0.016,0.012];
            const SEVEN_STRING_TUNING_HZ = [61.74, ...GUITAR_TUNING_HZ], SEVEN_STRING_GAUGES = [0.059, ...GUITAR_GAUGES];
            const EIGHT_STRING_TUNING_HZ = [46.25, ...SEVEN_STRING_TUNING_HZ], EIGHT_STRING_GAUGES = [0.074, ...SEVEN_STRING_GAUGES];
            const JUST_INTONATION_RATIOS = [1/1, 16/15, 9/8, 6/5, 5/4, 4/3, 45/32, 3/2, 8/5, 5/3, 9/5, 15/8];
            const CHORD_DEFINITIONS = { 'Major': {intervals:[0,4,7]},'Minor': {intervals:[0,3,7]},'Diminished': {intervals:[0,3,6]},'Augmented': {intervals:[0,4,8]},'Dominant 7th': {intervals:[0,4,7,10]},'Major 7th': {intervals:[0,4,7,11]},'Minor 7th': {intervals:[0,3,7,10]},'Suspended 2nd': {intervals:[0,2,7]},'Suspended 4th': {intervals:[0,5,7]},'Major 9th': {intervals:[0,4,7,11,14]},'Dominant 9th': {intervals:[0,4,7,10,14]},'Minor 9th': {intervals:[0,3,7,10,14]},'Major 6th': {intervals:[0,4,7,9]},'Minor 6th': {intervals:[0,3,7,9]},'11th':{intervals:[0,4,7,10,17]},'Dominant 13th':{intervals:[0,4,7,10,14,21]},'Major 13th':{intervals:[0,4,7,11,14,21]},'Minor 13th':{intervals:[0,3,7,10,14,21]} };
            const SCALE_DEFINITIONS = {'Major':[0,2,4,5,7,9,11],'Natural Minor':[0,2,3,5,7,8,10],'Harmonic Minor':[0,2,3,5,7,8,11],'Melodic Minor':[0,2,3,5,7,9,11],'Major Pentatonic':[0,2,4,7,9],'Minor Pentatonic':[0,3,5,7,10],'Blues':[0,3,5,6,7,10],'Dorian':[0,2,3,5,7,9,10],'Phrygian':[0,1,3,5,7,8,10],'Lydian':[0,2,4,6,7,9,11]};
            const INTERVAL_NAMES = {0:'R',1:'b2',2:'2',3:'b3',4:'3',5:'4',6:'b5',7:'5',8:'#5',9:'6',10:'b7',11:'7',12:'R',13:'b9',14:'9',15:'#9',16:'b11',17:'11',18:'#11',19:'b13',20:'6',21:'13'};
            const VOICING_LIBRARY = { 'C': {'Major':[null,2,1,-1,0,-1]},'A': {'Major':[null,-1,1,1,1,-1],'Minor':[null,-1,1,1,0,-1]},'G': {'Major':[2,1,-1,-1,-1,2]},'E': {'Major':[-1,1,1,0,-1,-1],'Minor':[-1,1,1,-1,-1,-1]},'D': {'Major':[null,null,-1,1,2,1],'Minor':[null,null,-1,1,2,0]} };
            
            // --- STATE ---
            let state = { strings: [], frets: 12, notes: [], fretPositions: [], currentChord: null, currentScale: null, tuningPanelVisible: true, noteDisplayMode: 'names', notesPerStringLimit: 'all' };

            // --- DOM ELEMENTS ---
            const mainLayout = document.getElementById('main-layout'), stringControlsContainer = document.getElementById('string-controls-container'), fretboardContainer = document.getElementById('fretboard-container');
            const fretCountEl = document.getElementById('fret-count');
            const addStringBelowBtn = document.getElementById('add-string-below'), addStringAboveBtn = document.getElementById('add-string-above');
            const addFretBtn = document.getElementById('add-fret'), removeFretBtn = document.getElementById('remove-fret');
            const rootNoteSelect = document.getElementById('root-note-select'), chordTypeSelect = document.getElementById('chord-type-select'), showChordBtn = document.getElementById('show-chord-btn'), clearFretboardBtn = document.getElementById('clear-fretboard-btn'), recognizedChordDisplay = document.getElementById('recognized-chord-display');
            const scaleTypeSelect = document.getElementById('scale-type-select'), showScaleBtn = document.getElementById('show-scale-btn'), randomScaleBtn = document.getElementById('random-scale-btn'), notesPerStringSelect = document.getElementById('notes-per-string-select');
            const resetFretsBtn = document.getElementById('reset-frets'), toggleTuningBtn = document.getElementById('toggle-tuning-panel'), displayModeSelect = document.getElementById('display-mode'), setupSelect = document.getElementById('setup-select');

            // --- HELPER, PHYSICS & CHORD/SCALE FUNCTIONS ---
            function calculateFrequency(string) { if (!string || string.length <= 0 || string.width <= 0 || string.tension <= 0) return 0; const length_m = string.length * INCH_TO_METER, width_m = string.width * INCH_TO_METER, tension_N = string.tension * LBS_TO_NEWTONS; const radius_m = width_m / 2, area_m2 = Math.PI * Math.pow(radius_m, 2), linearDensity_mu = STEEL_DENSITY_KG_M3 * area_m2; return (1 / (2 * length_m)) * Math.sqrt(tension_N / linearDensity_mu); }
            function calculateTension(string, targetFrequency) { if (!string || string.length <= 0 || string.width <= 0 || targetFrequency <= 0) return 0; const length_m = string.length * INCH_TO_METER, width_m = string.width * INCH_TO_METER; const radius_m = width_m / 2, area_m2 = Math.PI * Math.pow(radius_m, 2), linearDensity_mu = STEEL_DENSITY_KG_M3 * area_m2; const tension_N = linearDensity_mu * Math.pow(targetFrequency * 2 * length_m, 2); return tension_N / LBS_TO_NEWTONS; }
            function calculateFrettedFrequency(stringIndex, fretIndex) { const string = state.strings[stringIndex]; if (fretIndex === -1) return calculateFrequency(string); const fretDividerPosition = state.fretPositions[stringIndex][fretIndex + 1]; const lengthRatio = (100 - fretDividerPosition) / 100; const frettedLength = string.length * lengthRatio; return calculateFrequency({ ...string, length: frettedLength }); }
            function createStringWithTuning(freq, gauge) { const tempString = { length: 24.0, width: gauge }; return { ...tempString, tension: calculateTension(tempString, freq) }; }
            function frequencyToMidi(frequency) { return Math.round(69 + 12 * Math.log2(frequency / 440.0)); }
            function frequencyToNoteName(frequency) { if (frequency <= 0) return "N/A"; const midiNoteNumber = frequencyToMidi(frequency); return `${NOTE_NAMES[midiNoteNumber % 12]}${Math.floor(midiNoteNumber / 12) - 1}`; }
            function generateInitialFretPositions(mode = 'tet') {
                state.fretPositions = [];
                for (let i = 0; i < state.strings.length; i++) {
                    const stringFrets = [0];
                    if (mode === 'just') {
                        for(let j=0; j < state.frets; j++) { const ratio = JUST_INTONATION_RATIOS[j % 12] * Math.pow(2, Math.floor(j/12)); stringFrets.push((1 - (1 / ratio)) * 100); }
                    } else {
                        const twelfthRootOfTwo = Math.pow(2, 1 / 12); let remainingLength = 100;
                        for (let j = 0; j < state.frets; j++) { stringFrets.push(100 - (remainingLength / twelfthRootOfTwo)); remainingLength /= twelfthRootOfTwo; }
                    }
                    stringFrets.push(100); state.fretPositions.push(stringFrets);
                }
            }
            function findChordVoicing(rootNoteIndex, chordType, chordIntervals) {
                const rootNoteName = NOTE_NAMES[rootNoteIndex];
                if (state.strings.length === 6 && VOICING_LIBRARY[rootNoteName] && VOICING_LIBRARY[rootNoteName][chordType]) {
                    const pattern = VOICING_LIBRARY[rootNoteName][chordType];
                    return pattern.map((fret, string) => ({ string, fret, interval: fret === null ? 'X' : INTERVAL_NAMES[CHORD_DEFINITIONS[chordType].intervals.find(i => (rootNoteIndex + i) % 12 === (frequencyToMidi(calculateFrettedFrequency(string, fret))) % 12)], finger: fret === null ? 'X' : (fret === -1 ? 'O' : (fret + 1).toString()) }));
                }
                const chordNoteIndexes = chordIntervals.map(i => (rootNoteIndex + i) % 12); let voicing = [];
                for (let i = 0; i < state.strings.length; i++) {
                    const openStringMidi = frequencyToMidi(calculateFrequency(state.strings[i])); let bestFret = null; let foundInterval = -1;
                    for (let fret = -1; fret < state.frets; fret++) {
                        const currentNoteMidi = openStringMidi + (fret + 1); const currentNoteIndex = currentNoteMidi % 12;
                        if (chordNoteIndexes.includes(currentNoteIndex)) { bestFret = fret; foundInterval = chordIntervals.find(interval => (rootNoteIndex + interval) % 12 === currentNoteIndex); break; }
                    }
                    if (bestFret !== null) { voicing.push({ string: i, fret: bestFret, interval: INTERVAL_NAMES[foundInterval], finger: bestFret === -1 ? 'O' : (bestFret + 1).toString() }); } 
                    else { voicing.push({ string: i, fret: null, interval: 'X', finger: 'X' }); }
                }
                return voicing;
            }
            function recognizeChord(notes) {
                if (notes.length < 3) return null;
                const pitchClasses = [...new Set(notes.map(n => frequencyToMidi(calculateFrettedFrequency(n.string, n.fret)) % 12))];
                if (pitchClasses.length < 3) return null;

                for (const potentialRoot of pitchClasses) {
                    const intervals = pitchClasses.map(pc => (pc - potentialRoot + 12) % 12).sort((a,b) => a - b);
                    const definitionKeys = Object.keys(CHORD_DEFINITIONS);
                    for (const chordName of definitionKeys) {
                        const defIntervals = CHORD_DEFINITIONS[chordName].intervals;
                        if (intervals.length === defIntervals.length && intervals.every((val, index) => val === defIntervals[index])) {
                            return { root: NOTE_NAMES[potentialRoot], type: chordName };
                        }
                    }
                }
                return null;
            }

            // --- RENDER FUNCTIONS ---
            function renderApp() {
                if (state.tuningPanelVisible) { stringControlsContainer.style.display = 'flex'; mainLayout.style.gridTemplateColumns = '460px 1fr'; toggleTuningBtn.textContent = 'Hide Tuning'; } else { stringControlsContainer.style.display = 'none'; mainLayout.style.gridTemplateColumns = '1fr'; toggleTuningBtn.textContent = 'Show Tuning'; }
                const recognized = (!state.currentChord && !state.currentScale && state.notes.length > 0) ? recognizeChord(state.notes) : null;
                recognizedChordDisplay.textContent = recognized ? `Recognized: ${recognized.root} ${recognized.type}` : '';
                stringControlsContainer.innerHTML = ''; fretboardContainer.innerHTML = '';
                state.strings.forEach((string, i) => { if(state.tuningPanelVisible) renderStringControlPanel(string, i); renderStringRow(string, i); });
                updateGlobalControls(); attachEventListeners();
            }
            function renderStringControlPanel(string, index) { const panel = document.createElement('div'); panel.className = 'string-control-panel'; const freq = calculateFrequency(string), noteName = frequencyToNoteName(freq); panel.innerHTML = `<div class="input-group"><label for="len-${index}">Len:</label><input type="number" id="len-${index}" value="${string.length.toFixed(1)}" step="0.1" min="20" max="30"></div><div class="input-group"><label for="wid-${index}">Gauge:</label><input type="number" id="wid-${index}" value="${string.width.toFixed(3)}" step="0.001" min="0.007" max="0.080"></div><div class="input-group"><label for="ten-${index}">Ten (lbs):</label><input type="number" id="ten-${index}" value="${string.tension.toFixed(1)}" step="0.5" min="5" max="50"></div><div class="info-display"><span>${freq.toFixed(1)} Hz</span><span>${noteName}</span></div><button class="remove-string-btn" data-string-index="${index}" title="Remove this string">X</button>`; stringControlsContainer.appendChild(panel); panel.querySelector(`#len-${index}`).addEventListener('input', e => { clearTheory(); state.strings[index].length = parseFloat(e.target.value) || 0; renderApp(); }); panel.querySelector(`#wid-${index}`).addEventListener('input', e => { clearTheory(); state.strings[index].width = parseFloat(e.target.value) || 0; renderApp(); }); panel.querySelector(`#ten-${index}`).addEventListener('input', e => { clearTheory(); state.strings[index].tension = parseFloat(e.target.value) || 0; renderApp(); }); }
            function renderStringRow(string, i) {
                const stringRow = document.createElement('div'); stringRow.className = 'string-row'; stringRow.dataset.stringIndex = i;
                const openSpace = document.createElement('div'); openSpace.className = 'fret-space open-string-space'; openSpace.dataset.stringIndex = i; openSpace.dataset.fretIndex = -1; stringRow.appendChild(openSpace);
                const frettedArea = document.createElement('div'); frettedArea.className = 'fretted-area';
                for (let j = 0; j < state.frets; j++) { const fretSpace = document.createElement('div'); fretSpace.className = 'fret-space'; fretSpace.style.width = `${state.fretPositions[i][j + 1] - state.fretPositions[i][j]}%`; fretSpace.dataset.stringIndex = i; fretSpace.dataset.fretIndex = j; frettedArea.appendChild(fretSpace); if (j < state.frets) { const fretDivider = document.createElement('div'); fretDivider.className = 'fret-divider'; fretDivider.style.left = `${state.fretPositions[i][j + 1]}%`; fretDivider.dataset.stringIndex = i; fretDivider.dataset.fretIndex = j + 1; frettedArea.appendChild(fretDivider); } }
                stringRow.appendChild(frettedArea);
                state.notes.filter(n => n.string === i).forEach(note => {
                    if (note.fret === null) { const muteMarker = document.createElement('div'); muteMarker.className = 'mute-marker'; muteMarker.textContent = (state.noteDisplayMode === 'fingerings' || state.noteDisplayMode === 'intervals') ? 'X' : ''; openSpace.appendChild(muteMarker); return; }
                    const noteEl = document.createElement('div'); noteEl.className = 'note'; noteEl.draggable = !state.currentChord && !state.currentScale;
                    noteEl.dataset.string = note.string; noteEl.dataset.fretIndex = note.fret;
                    const frettedFreq = calculateFrettedFrequency(note.string, note.fret);
                    switch(state.noteDisplayMode) {
                        case 'names': noteEl.textContent = frequencyToNoteName(frettedFreq); break;
                        case 'frequencies': noteEl.textContent = `${frettedFreq.toFixed(0)}Hz`; break;
                        case 'intervals': noteEl.textContent = note.interval || '?'; break;
                        case 'fingerings': noteEl.textContent = note.finger || (note.fret === -1 ? 'O' : (note.fret + 1)); break;
                    }
                    if (note.fret === -1) { noteEl.style.left = '50%'; openSpace.appendChild(noteEl); } 
                    else { const fretStart = state.fretPositions[note.string][note.fret], fretEnd = state.fretPositions[note.string][note.fret + 1]; noteEl.style.left = `${fretStart + (fretEnd - fretStart) / 2}%`; frettedArea.appendChild(noteEl); }
                });
                fretboardContainer.appendChild(stringRow);
            }
            
            // --- EVENT LISTENERS & HANDLERS ---
            function attachEventListeners() { document.body.addEventListener('click', handleDelegatedClick); fretboardContainer.addEventListener('mousedown', handleFretDragStart); document.querySelectorAll('.note').forEach(note => { if(note.draggable) note.addEventListener('dragstart', handleNoteDragStart) }); document.querySelectorAll('.string-row').forEach(row => { row.addEventListener('dragover', e => e.preventDefault()); row.addEventListener('drop', handleNoteDrop); }); }
            function handleDelegatedClick(e) {
                const fretSpace = e.target.closest('.fret-space'); if (fretSpace) { if(state.currentChord || state.currentScale) clearTheory(); const stringIndex = parseInt(fretSpace.dataset.stringIndex), fretIndex = parseInt(fretSpace.dataset.fretIndex); const noteExists = state.notes.some(n => n.string === stringIndex && n.fret === fretIndex); if (noteExists) removeNote(stringIndex, fretIndex); else addNote(stringIndex, fretIndex); return; }
                const removeBtn = e.target.closest('.remove-string-btn'); if (removeBtn) { removeString(parseInt(removeBtn.dataset.stringIndex)); return; }
            }
            let dragInfo = null;
            function handleFretDragStart(e) { if (!e.target.classList.contains('fret-divider')) return; const stringIndex = parseInt(e.target.dataset.stringIndex), fretIndex = parseInt(e.target.dataset.fretIndex); if (fretIndex === 0 || fretIndex > state.frets) return; dragInfo = { element: e.target, stringIndex, fretIndex, startX: e.clientX, fretboardWidth: e.target.parentElement.clientWidth }; document.addEventListener('mousemove', handleFretDrag); document.addEventListener('mouseup', handleFretDragEnd); }
            function handleFretDrag(e) { if(!dragInfo) return; e.preventDefault(); const dx = e.clientX - dragInfo.startX, dPercent = (dx / dragInfo.fretboardWidth) * 100, originalPos = state.fretPositions[dragInfo.stringIndex][dragInfo.fretIndex]; let newPos = originalPos + dPercent; const leftBoundary = state.fretPositions[dragInfo.stringIndex][dragInfo.fretIndex - 1] + 1, rightBoundary = state.fretPositions[dragInfo.stringIndex][dragInfo.fretIndex + 1] - 1; newPos = Math.max(leftBoundary, Math.min(newPos, rightBoundary)); dragInfo.element.style.left = `${newPos}%`; }
            function handleFretDragEnd(e) { if (!dragInfo) return; const finalPercent = parseFloat(dragInfo.element.style.left); state.fretPositions[dragInfo.stringIndex][dragInfo.fretIndex] = finalPercent; dragInfo = null; document.removeEventListener('mousemove', handleFretDrag); document.removeEventListener('mouseup', handleFretDragEnd); renderApp(); }
            function handleNoteDragStart(e) { e.target.classList.add('dragging'); e.dataTransfer.setData('application/json', JSON.stringify({ string: e.target.dataset.string, fretIndex: e.target.dataset.fretIndex })); e.dataTransfer.effectAllowed = 'move'; }
            function handleNoteDrop(e) { e.preventDefault(); e.target.classList.remove('dragging'); const dropFretSpace = e.target.closest('.fret-space'); if (!dropFretSpace) return; const dragData = JSON.parse(e.dataTransfer.getData('application/json')); const fromString = parseInt(dragData.string); const toFretIndex = parseInt(dropFretSpace.dataset.fretIndex), toRowString = parseInt(dropFretSpace.dataset.stringIndex); if (fromString !== toRowString || parseInt(dragData.fretIndex) === toFretIndex) return; moveNote(fromString, parseInt(dragData.fretIndex), toFretIndex); }
            function handleShowChord() { const rootNoteIndex = parseInt(rootNoteSelect.value); const chordType = chordTypeSelect.value; const intervals = CHORD_DEFINITIONS[chordType].intervals; const voicing = findChordVoicing(rootNoteIndex, chordType, intervals); clearTheory(); state.currentChord = { root: rootNoteIndex, type: chordType, notes: voicing }; state.notes = voicing; renderApp(); }
            function handleShowScale() { const rootNoteIndex = parseInt(rootNoteSelect.value); const scaleType = scaleTypeSelect.value; const intervals = SCALE_DEFINITIONS[scaleType]; clearTheory(); state.currentScale = { root: rootNoteIndex, type: scaleType, intervals: intervals }; state.notesPerStringLimit = notesPerStringSelect.value; const rootMidi = 48 + rootNoteIndex; let allScaleNotes = []; const scalePitchClasses = intervals.map(i => (rootNoteIndex + i) % 12); for (let i = 0; i < state.strings.length; i++) { const openStringMidi = frequencyToMidi(calculateFrequency(state.strings[i])); for (let j = -1; j < state.frets; j++) { const currentNoteMidi = openStringMidi + (j + 1); if (scalePitchClasses.includes(currentNoteMidi % 12)) { const intervalSemitones = (currentNoteMidi - rootMidi) % 12; allScaleNotes.push({ string: i, fret: j, interval: INTERVAL_NAMES[intervalSemitones < 0 ? intervalSemitones + 12 : intervalSemitones] }); } } } if (state.notesPerStringLimit === 'all') { state.notes = allScaleNotes; } else { const limit = parseInt(state.notesPerStringLimit); const notesByString = allScaleNotes.reduce((acc, note) => { (acc[note.string] = acc[note.string] || []).push(note); return acc; }, {}); state.notes = Object.values(notesByString).flatMap(stringNotes => stringNotes.slice(0, limit)); } renderApp(); }
            function handleRandomScale() { rootNoteSelect.selectedIndex = Math.floor(Math.random() * rootNoteSelect.options.length); scaleTypeSelect.selectedIndex = Math.floor(Math.random() * scaleTypeSelect.options.length); handleShowScale(); }
            function clearTheory() { state.notes = []; state.currentChord = null; state.currentScale = null; renderApp(); }
            function handleSetupChange(e) { const setup = e.target.value; if (!setup) return; clearTheory(); switch(setup) { case 'guitar': setTuning(6, 12, GUITAR_TUNING_HZ, GUITAR_GAUGES); break; case 'bass': setTuning(4, 20, BASS_TUNING_HZ, BASS_GAUGES); break; case 'ukulele': setTuning(4, 12, UKULELE_TUNING_HZ, UKULELE_GAUGES); break; case 'drop_d': setTuning(6, 12, DROP_D_TUNING_HZ, DROP_D_GAUGES); break; case 'open_g': setTuning(6, 12, OPEN_G_TUNING_HZ, OPEN_G_GAUGES); break; case 'dadgad': setTuning(6, 12, DADGAD_TUNING_HZ, DADGAD_GAUGES); break; case '7_string': setTuning(7, 24, SEVEN_STRING_TUNING_HZ, SEVEN_STRING_GAUGES); break; case '8_string': setTuning(8, 24, EIGHT_STRING_TUNING_HZ, EIGHT_STRING_GAUGES); break; case 'just_intonation': setTuning(6, 12, GUITAR_TUNING_HZ, GUITAR_GAUGES, 'just'); break; case 'overtone': handleOvertoneDemo(); break; } renderApp(); e.target.value = ""; }
            function setTuning(numStrings, numFrets, tuningHz, gauges, temperament = 'tet') { state.frets = numFrets; state.strings = Array.from({ length: numStrings }, (_, i) => createStringWithTuning(tuningHz[i], gauges[i])); generateInitialFretPositions(temperament); }
            function handleOvertoneDemo() { const fundamentalHz = 65.41; const numStrings = 8; const demoGauges = [0.070, 0.056, 0.046, 0.036, 0.026, 0.017, 0.013, 0.010]; let newStrings = []; for (let i = 0; i < numStrings; i++) { newStrings.push(createStringWithTuning(fundamentalHz * (i + 1), demoGauges[i] || 0.010)); } state.strings = newStrings; state.frets = 0; generateInitialFretPositions(); }

            // --- STATE MODIFICATION ---
            function addNote(string, fretIndex) { state.notes.push({ string: string, fret: fretIndex }); renderApp(); }
            function removeNote(string, fretIndex) { state.notes = state.notes.filter(n => !(n.string === string && n.fret === fretIndex)); renderApp(); }
            function moveNote(string, fromFret, toFret) { removeNote(string, toFret); const noteToMove = state.notes.find(n => n.string === string && n.fret === fromFret); if (noteToMove) noteToMove.fret = toFret; renderApp(); }
            function addString(location) { if (state.strings.length >= MAX_STRINGS) return; if (state.strings.length === 0) { state.strings.push(createStringWithTuning(82.41, 0.042)); } else { const semitoneShift = location === 'below' ? -5 : 5; const gaugeRatio = location === 'below' ? 1.3 : 1 / 1.3; const refIndex = location === 'below' ? 0 : state.strings.length - 1; const refString = state.strings[refIndex]; const refFreq = calculateFrequency(refString); const newFreq = refFreq * Math.pow(2, semitoneShift / 12); const newGauge = refString.width * gaugeRatio; const newString = createStringWithTuning(newFreq, newGauge); if (location === 'below') { state.strings.unshift(newString); if(state.currentChord || state.currentScale) clearTheory(); state.notes.forEach(n => n.string++); } else { state.strings.push(newString); } } generateInitialFretPositions(); renderApp(); }
            function removeString(indexToRemove) { if (state.strings.length <= MIN_STRINGS) return; clearTheory(); state.strings.splice(indexToRemove, 1); state.fretPositions.splice(indexToRemove, 1); state.notes = state.notes.filter(n => n.string !== indexToRemove).map(n => { if (n.string > indexToRemove) n.string--; return n; }); renderApp(); }
            function changeFrets(amount) { const newCount = state.frets + amount; if (newCount >= MIN_FRETS && newCount <= MAX_FRETS) { clearTheory(); state.frets = newCount; generateInitialFretPositions(); renderApp(); } }
            
            // --- UI UPDATE & INITIALIZATION ---
            function populateDropdowns() { NOTE_NAMES.forEach((name, i) => rootNoteSelect.innerHTML += `<option value="${i}">${name}</option>`); Object.keys(CHORD_DEFINITIONS).forEach(name => chordTypeSelect.innerHTML += `<option value="${name}">${name}</option>`); Object.keys(SCALE_DEFINITIONS).forEach(name => scaleTypeSelect.innerHTML += `<option value="${name}">${name}</option>`); }
            function updateGlobalControls() { fretCountEl.textContent = state.frets; addStringAboveBtn.disabled = state.strings.length >= MAX_STRINGS; addStringBelowBtn.disabled = state.strings.length >= MAX_STRINGS; removeFretBtn.disabled = state.frets <= MIN_FRETS; addFretBtn.disabled = state.frets >= MAX_FRETS; document.querySelectorAll('.remove-string-btn').forEach(btn => btn.disabled = (state.strings.length <= MIN_STRINGS)); }
            addStringBelowBtn.addEventListener('click', () => addString('below')); addStringAboveBtn.addEventListener('click', () => addString('above')); addFretBtn.addEventListener('click', () => changeFrets(1)); removeFretBtn.addEventListener('click', () => changeFrets(-1));
            resetFretsBtn.addEventListener('click', () => { clearTheory(); setTuning(6, 12, GUITAR_TUNING_HZ, GUITAR_GAUGES); renderApp(); });
            toggleTuningBtn.addEventListener('click', () => { state.tuningPanelVisible = !state.tuningPanelVisible; renderApp(); });
            displayModeSelect.addEventListener('change', (e) => { state.noteDisplayMode = e.target.value; renderApp(); });
            showChordBtn.addEventListener('click', handleShowChord); clearFretboardBtn.addEventListener('click', clearTheory);
            showScaleBtn.addEventListener('click', handleShowScale); randomScaleBtn.addEventListener('click', handleRandomScale);
            notesPerStringSelect.addEventListener('change', (e) => { state.notesPerStringLimit = e.target.value; if (state.currentScale) { handleShowScale(); } });
            setupSelect.addEventListener('change', handleSetupChange);
            
            populateDropdowns(); setTuning(6, 12, GUITAR_TUNING_HZ, GUITAR_GAUGES); renderApp();
        });
    </script>
</body>
</html>
